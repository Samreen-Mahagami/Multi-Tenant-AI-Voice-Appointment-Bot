version: "3.9"

networks:
  ivr-network:
    driver: bridge

volumes:
  freeswitch-sounds:

services:
  # ===========================================
  # TENANT CONFIG SERVICE
  # ===========================================
  tenant-config-go:
    build: ./tenant-config-go
    container_name: tenant-config-go
    networks:
      - ivr-network
    ports:
      - "7001:7001"
    volumes:
      - ./tenant-config-go/tenants.yaml:/app/tenants.yaml:ro
    environment:
      - PORT=7001
      - CONFIG_PATH=/app/tenants.yaml
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7001/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ===========================================
  # APPOINTMENT SERVICE
  # ===========================================
  appointment-service-go:
    build: ./appointment-service-go
    container_name: appointment-service-go
    networks:
      - ivr-network
    ports:
      - "7002:7002"
    environment:
      - PORT=7002
    depends_on:
      tenant-config-go:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7002/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ===========================================
  # MEDIA GATEWAY (FreeSWITCH Bridge)
  # ===========================================
  media-gateway-go:
    build: ./media-gateway-go
    container_name: media-gateway-go
    networks:
      - ivr-network
    ports:
      - "8080:8080"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEDROCK_AGENT_ID=${BEDROCK_AGENT_ID}
      - BEDROCK_AGENT_ALIAS_ID=${BEDROCK_AGENT_ALIAS_ID}
      - TENANT_CONFIG_URL=http://tenant-config-go:7001
      - APPOINTMENT_SERVICE_URL=http://appointment-service-go:7002
      - S3_BUCKET=${S3_BUCKET:-clinic-voice-processing-089580247707}
    volumes:
      - ~/.aws:/root/.aws:ro
    depends_on:
      tenant-config-go:
        condition: service_healthy
      appointment-service-go:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ===========================================
  # FREESWITCH
  # ===========================================
  freeswitch:
    image: andrius/freeswitch
    container_name: freeswitch
    networks:
      - ivr-network
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "5081:5080/udp"  # Changed to avoid conflict
      - "8021:8021/tcp"
      - "16384-16484:16384-16484/udp"
    volumes:
      - ./freeswitch/conf/dialplan:/etc/freeswitch/dialplan:ro
      - ./freeswitch/conf/directory:/etc/freeswitch/directory:ro
      - ./freeswitch/conf/autoload_configs/event_socket.conf.xml:/etc/freeswitch/autoload_configs/event_socket.conf.xml:ro
      - ./freeswitch/conf/autoload_configs/modules.conf.xml:/etc/freeswitch/autoload_configs/modules.conf.xml:ro
      - freeswitch-sounds:/usr/share/freeswitch/sounds
    depends_on:
      media-gateway-go:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "fs_cli", "-x", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s