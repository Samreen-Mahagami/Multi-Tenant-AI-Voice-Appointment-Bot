<!DOCTYPE html>
<html>
<head>
    <title>Text-Based Voice Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .chat { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; height: 400px; overflow-y: auto; }
        .message { margin: 10px 0; padding: 10px; border-radius: 6px; }
        .user { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .bot { background: #f3e5f5; border-left: 4px solid #9c27b0; }
        input { width: 70%; padding: 10px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .clinic-btn { display: block; width: 100%; margin: 5px 0; padding: 15px; background: #28a745; color: white; text-align: left; }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ Text-Based Voice Demo</h1>
    <p>This simulates the voice conversation without microphone issues</p>
    
    <h3>Select Clinic:</h3>
    <button class="clinic-btn" onclick="selectClinic('1001', 'Downtown Medical Center')">
        1001 - Downtown Medical Center (Joanna voice)
    </button>
    <button class="clinic-btn" onclick="selectClinic('1002', 'Westside Family Practice')">
        1002 - Westside Family Practice (Matthew voice)
    </button>
    <button class="clinic-btn" onclick="selectClinic('1003', 'Pediatric Care Clinic')">
        1003 - Pediatric Care Clinic (Amy voice)
    </button>
    
    <div id="chat" class="chat">
        <div class="message bot">Select a clinic above to start the conversation!</div>
    </div>
    
    <div>
        <input type="text" id="userInput" placeholder="Type what you would say..." disabled>
        <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
        <button onclick="speakLastResponse()" id="speakBtn" disabled>ðŸ”Š Speak Last Response</button>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>Quick Test Phrases:</h4>
        <button onclick="quickSend('Hi, I need an appointment')">ðŸ’¬ "Hi, I need an appointment"</button>
        <button onclick="quickSend('Tomorrow morning please')">ðŸ’¬ "Tomorrow morning please"</button>
        <button onclick="quickSend('The 9:30 slot sounds good')">ðŸ’¬ "The 9:30 slot sounds good"</button>
        <button onclick="quickSend('My name is John Smith')">ðŸ’¬ "My name is John Smith"</button>
        <button onclick="quickSend('john.smith@example.com')">ðŸ’¬ "john.smith@example.com"</button>
    </div>

    <script>
        let selectedDID = null;
        let selectedClinic = null;
        let websocket = null;
        let lastBotResponse = '';

        function addMessage(text, type) {
            const chat = document.getElementById('chat');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'user' ? 'ðŸ‘¤ You' : 'ðŸ¤– AI Bot';
            message.innerHTML = `<strong>${icon}:</strong> ${text} <small style="color: #666;">[${timestamp}]</small>`;
            chat.appendChild(message);
            chat.scrollTop = chat.scrollHeight;
        }

        function selectClinic(did, clinicName) {
            selectedDID = did;
            selectedClinic = clinicName;
            
            // Clear chat
            document.getElementById('chat').innerHTML = '';
            
            // Connect to WebSocket
            const callId = `demo-${Date.now()}`;
            const wsUrl = `ws://localhost:8080/ws/audio?callId=${callId}&did=${did}`;
            
            addMessage(`Connecting to ${clinicName}...`, 'bot');
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                addMessage(`Connected to ${clinicName}! You can now type your messages.`, 'bot');
                document.getElementById('userInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                
                // The greeting should come automatically
                setTimeout(() => {
                    // Simulate the greeting that would normally come from voice
                    const greetings = {
                        '1001': 'Hello, thank you for calling Downtown Medical Center. How can I help you today?',
                        '1002': 'Hi there! This is Westside Family Practice. What can I do for you?',
                        '1003': 'Hello! You\'ve reached Pediatric Care Clinic. How may I assist you today?'
                    };
                    addMessage(greetings[did], 'bot');
                    lastBotResponse = greetings[did];
                    document.getElementById('speakBtn').disabled = false;
                }, 1000);
            };
            
            websocket.onmessage = function(event) {
                if (typeof event.data === 'string') {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'response') {
                            addMessage(data.text, 'bot');
                            lastBotResponse = data.text;
                            document.getElementById('speakBtn').disabled = false;
                        }
                    } catch (e) {
                        addMessage(event.data, 'bot');
                    }
                }
            };
            
            websocket.onerror = function(error) {
                addMessage('Connection error. Make sure services are running.', 'bot');
            };
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message || !websocket) return;
            
            addMessage(message, 'user');
            
            // Simulate sending audio by sending text
            // In real implementation, this would be transcribed speech
            websocket.send(JSON.stringify({
                type: 'text_input',
                text: message
            }));
            
            input.value = '';
        }

        function quickSend(message) {
            if (!websocket) {
                addMessage('Please select a clinic first!', 'bot');
                return;
            }
            
            document.getElementById('userInput').value = message;
            sendMessage();
        }

        function speakLastResponse() {
            if (!lastBotResponse) return;
            
            const utterance = new SpeechSynthesisUtterance(lastBotResponse);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 0.8;
            
            speechSynthesis.speak(utterance);
            addMessage('ðŸ”Š Speaking response...', 'bot');
        }

        // Enter key support
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>